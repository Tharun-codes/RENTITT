<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Post Property - RENTit</title>
  <link rel="stylesheet" href="./style.css">
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
</head>
<body>
  <div class="form-container">
    <!-- Header -->
    <div class="form-header">
      <a href="index.html" class="logo mb-4">RENTit</a>
      <h2>Post a Property</h2>
      <p>Fill in the details below to list your property</p>
    </div>

    <!-- Form Card -->
    <div class="form-card">
      <form onsubmit="event.preventDefault(); postProperty();">
        <!-- Basic Information -->
        <div class="form-section">
          <h3 class="form-section-title">Basic Information</h3>
          <div class="form-grid">
            <div class="form-group">
              <label for="title" class="form-label">
                Property Title *
              </label>
              <input id="title" 
                     placeholder="e.g., Modern 2BHK Apartment"
                     required
                     class="form-input"/>
            </div>

            <div class="form-group">
              <label for="location" class="form-label">
                Location *
              </label>
              <input id="location" 
                     placeholder="e.g., Mumbai, Maharashtra"
                     required
                     class="form-input"/>
            </div>
          </div>
        </div>

        <!-- Property Details -->
        <div class="form-section">
          <h3 class="form-section-title">Property Details</h3>
          <div class="form-grid">
            <div class="form-group">
              <label for="propertyType" class="form-label">
                Property Type *
              </label>
              <select id="propertyType" required class="form-select">
                <option value="apartment">Apartment</option>
                <option value="house">House</option>
                <option value="villa">Villa</option>
                <option value="studio">Studio</option>
              </select>
            </div>

            <div class="form-group">
              <label for="transaction" class="form-label">
                Transaction Type *
              </label>
              <select id="transaction" required class="form-select">
                <option value="rent">For Rent</option>
                <option value="sale">For Sale</option>
              </select>
            </div>

            <div class="form-group">
              <label for="bedrooms" class="form-label">
                Bedrooms *
              </label>
              <input id="bedrooms" 
                     type="number" 
                     min="1"
                     placeholder="Number of bedrooms"
                     required
                     class="form-input"/>
            </div>

            <div class="form-group">
              <label for="area" class="form-label">
                Area (sqft) *
              </label>
              <input id="area" 
                     type="number" 
                     min="1"
                     placeholder="Property area in square feet"
                     required
                     class="form-input"/>
            </div>
          </div>
        </div>

        <!-- Pricing & Media -->
        <div class="form-section">
          <h3 class="form-section-title">Pricing & Media</h3>
          <div class="form-grid">
            <div class="form-group">
              <label for="price" class="form-label">
                Price (₹) *
              </label>
              <input id="price" 
                     type="number" 
                     min="1"
                     placeholder="Enter price"
                     required
                     class="form-input"/>
            </div>

            <div class="form-group">
              <label for="image" class="form-label">
                Image URL *
              </label>
              <input id="image" 
                     type="url"
                     placeholder="https://example.com/image.jpg"
                     required
                     class="form-input"/>
            </div>
          </div>
        </div>

        <!-- Description -->
        <div class="form-section">
          <div class="form-group">
            <label for="description" class="form-label">
              Description *
            </label>
            <textarea id="description" 
                      rows="4"
                      placeholder="Describe your property in detail..."
                      required
                      class="form-textarea"></textarea>
          </div>
        </div>

        <!-- Submit Button -->
        <div class="form-section">
          <button type="submit" id="submitButton" class="btn btn-primary btn-full">
            Post Property
          </button>

          <p id="msg" class="form-message"></p>
        </div>
      </form>
    </div>

    <!-- Back Link -->
    <div class="back-link">
      <a href="index.html">← Back to Home</a>
    </div>
  </div>

<script>
const API = "http://localhost:5000/api/listings";

// Check authentication on page load
window.addEventListener('DOMContentLoaded', function() {
  const token = localStorage.getItem("token") || localStorage.getItem("rentit_token");
  
  if (!token) {
    alert("Please login first to post a property!");
    window.location.href = "login.html";
    return;
  }
  
  console.log("User is authenticated, token found");
});

async function postProperty() {
  const token = localStorage.getItem("token") || localStorage.getItem("rentit_token");

  if (!token) {
    alert("Please login first!");
    window.location.href = "login.html";
    return;
  }
  
  console.log("Posting property with token:", token.substring(0, 20) + "...");

  const submitButton = document.getElementById("submitButton");
  const msg = document.getElementById("msg");
  const originalText = submitButton.textContent;

  // Disable button and show loading
  submitButton.disabled = true;
  submitButton.innerHTML = '<span class="loading"></span> Posting Property...';
  msg.textContent = "";
  msg.className = "form-message";

  const data = {
    title: document.getElementById("title").value,
    location: document.getElementById("location").value,
    price: document.getElementById("price").value,
    image_url: document.getElementById("image").value,
    transaction_type: document.getElementById("transaction").value,
    property_type: document.getElementById("propertyType").value,
    bedrooms: document.getElementById("bedrooms").value,
    area_sqft: document.getElementById("area").value,
    description: document.getElementById("description").value
  };

  try {
    const res = await fetch(API, {
      method: "POST",
      headers: {
        "Content-Type": "application/json",
        "Authorization": `Bearer ${token}`
      },
      body: JSON.stringify(data)
    });

    if (!res.ok) {
      const err = await res.json();
      msg.textContent = err.error || "Error posting property";
      msg.className = "form-message message-error";
      submitButton.disabled = false;
      submitButton.textContent = originalText;
      return;
    }

    msg.textContent = "Property posted successfully! Redirecting...";
    msg.className = "form-message message-success";
    submitButton.textContent = "✓ Posted Successfully";

    setTimeout(() => {
      window.location.href = "index.html";
    }, 1500);

  } catch (err) {
    msg.textContent = "Unable to connect to server. Please try again.";
    msg.className = "form-message message-error";
    submitButton.disabled = false;
    submitButton.textContent = originalText;
  }
}
</script>

</body>
</html>
